<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MailMaster - Envío Masivo Real de Correos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- EmailJS para envío real de correos -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
</head>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    :root {
        --primary: #4361ee;
        --primary-light: #eef2ff;
        --secondary: #7b61ff;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --dark: #1e293b;
        --light: #f8fafc;
        --gray: #64748b;
        --gray-light: #e2e8f0;
        --white: #ffffff;
        --radius: 12px;
        --shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
        --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
        color: var(--dark);
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-lg);
        overflow: hidden;
    }

    /* Header */
    .header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: var(--white);
        padding: 30px 40px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .header h1 i {
        color: #ffd700;
    }

    .header p {
        opacity: 0.9;
        font-size: 1.1rem;
    }

    /* Main Content */
    .main-content {
        padding: 40px;
    }

    /* Pasos */
    .steps {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 40px;
    }

    .step {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: var(--gray-light);
        color: var(--gray);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        position: relative;
        cursor: pointer;
        transition: all 0.3s;
        border: 3px solid var(--white);
        box-shadow: var(--shadow);
    }

    .step.active {
        background: var(--primary);
        color: var(--white);
        transform: scale(1.1);
        box-shadow: 0 6px 15px rgba(67, 97, 238, 0.3);
    }

    .step.completed {
        background: var(--success);
        color: var(--white);
    }

    .step-line {
        flex: 1;
        height: 4px;
        background: var(--gray-light);
        margin-top: 20px;
    }

    .step-line.active {
        background: var(--primary);
    }

    /* Card */
    .card {
        background: var(--white);
        border-radius: var(--radius);
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid var(--gray-light);
        transition: all 0.3s;
        box-shadow: var(--shadow);
    }

    .card:hover {
        border-color: var(--primary);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.1);
    }

    .card h2 {
        color: var(--dark);
        margin-bottom: 25px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 1.5rem;
    }

    .card h2 i {
        color: var(--primary);
        background: var(--primary-light);
        width: 45px;
        height: 45px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Upload Area */
    .upload-area {
        border: 3px dashed var(--gray-light);
        border-radius: var(--radius);
        padding: 50px 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: var(--light);
    }

    .upload-area:hover, .upload-area.dragover {
        border-color: var(--primary);
        background: rgba(102, 126, 234, 0.05);
    }

    .upload-icon {
        font-size: 60px;
        color: var(--primary);
        margin-bottom: 20px;
        opacity: 0.8;
    }

    .upload-area h3 {
        color: var(--dark);
        margin-bottom: 15px;
        font-size: 1.3rem;
    }

    .upload-area p {
        color: var(--gray);
        margin-bottom: 20px;
        max-width: 500px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
    }

    /* Controles de selección */
    .selection-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        padding: 15px;
        background: var(--light);
        border-radius: 10px;
    }

    .selection-info {
        font-weight: 600;
        color: var(--dark);
    }

    .selection-info span {
        color: var(--primary);
        font-weight: 800;
    }

    /* Form Controls */
    .form-group {
        margin-bottom: 25px;
    }

    .form-label {
        display: block;
        color: var(--dark);
        margin-bottom: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 1.05rem;
    }

    .form-label i {
        color: var(--primary);
        width: 20px;
    }

    .form-control {
        width: 100%;
        padding: 14px 20px;
        border: 2px solid var(--gray-light);
        border-radius: 10px;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        transition: all 0.3s;
        background: var(--light);
    }

    .form-control:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        background: var(--white);
    }

    textarea.form-control {
        min-height: 200px;
        resize: vertical;
        line-height: 1.6;
    }

    select.form-control {
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 20px center;
        background-size: 16px;
        padding-right: 50px;
    }

    /* Checkbox personalizado - MEJORADO */
    .checkbox-group {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        user-select: none;
        transition: all 0.2s;
    }

    .checkbox-group:hover {
        transform: scale(1.05);
    }

    .checkbox-group input[type="checkbox"] {
        display: none;
    }

    .checkbox-custom {
        width: 22px;
        height: 22px;
        border: 2px solid var(--gray-light);
        border-radius: 6px;
        position: relative;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--white);
    }

    .checkbox-group input[type="checkbox"]:checked + .checkbox-custom {
        background: var(--primary);
        border-color: var(--primary);
        animation: checkAnim 0.3s ease;
    }

    .checkbox-group input[type="checkbox"]:checked + .checkbox-custom::after {
        content: '✓';
        color: var(--white);
        font-weight: bold;
        font-size: 14px;
        animation: fadeIn 0.3s ease;
    }

    .checkbox-group input[type="checkbox"]:indeterminate + .checkbox-custom {
        background: var(--primary-light);
        border-color: var(--primary);
    }

    .checkbox-group input[type="checkbox"]:indeterminate + .checkbox-custom::after {
        content: '–';
        color: var(--primary);
        font-weight: bold;
        font-size: 14px;
    }

    @keyframes checkAnim {
        0% { transform: scale(1); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    /* Botones */
    .btn {
        padding: 12px 25px;
        border: none;
        border-radius: 10px;
        font-family: 'Poppins', sans-serif;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        transition: all 0.3s;
        text-decoration: none;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: var(--white);
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
        color: var(--white);
    }

    .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
        color: var(--white);
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
    }

    .btn-secondary {
        background: var(--gray-light);
        color: var(--dark);
    }

    .btn-secondary:hover {
        background: #cbd5e1;
        transform: translateY(-2px);
    }

    .btn-sm {
        padding: 8px 15px;
        font-size: 0.9rem;
    }

    /* Tabla - MEJORADA */
    .table-container {
        overflow-x: auto;
        border-radius: 10px;
        border: 2px solid var(--gray-light);
        margin-bottom: 25px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        max-height: 500px;
        overflow-y: auto;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 700px;
    }

    th {
        background: var(--primary-light);
        padding: 15px;
        text-align: left;
        color: var(--dark);
        font-weight: 600;
        border-bottom: 2px solid var(--gray-light);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    td {
        padding: 12px 15px;
        border-bottom: 1px solid var(--gray-light);
        color: var(--dark);
        transition: all 0.2s;
    }

    tr:hover {
        background: var(--light);
        transform: translateX(5px);
    }

    tr.selected {
        background: rgba(102, 126, 234, 0.08);
        border-left: 4px solid var(--primary);
    }

    tr.selected:hover {
        background: rgba(102, 126, 234, 0.12);
    }

    .status {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .status.pending {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .status.selected {
        background: rgba(67, 97, 238, 0.1);
        color: var(--primary);
    }

    .status.success {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .status.error {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    /* Progress Bar */
    .progress-container {
        background: var(--white);
        padding: 25px;
        border-radius: var(--radius);
        margin-bottom: 25px;
        border: 2px solid var(--gray-light);
        box-shadow: var(--shadow);
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .progress-title {
        color: var(--primary);
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .progress-percent {
        font-weight: 800;
        color: var(--primary);
        font-size: 1.3rem;
    }

    .progress-bar {
        height: 12px;
        background: var(--gray-light);
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 15px;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--secondary));
        width: 0%;
        transition: width 0.5s ease;
        border-radius: 6px;
    }

    .progress-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 25px;
    }

    .stat-box {
        text-align: center;
        padding: 20px 15px;
        background: var(--light);
        border-radius: 10px;
        border: 1px solid var(--gray-light);
        transition: all 0.3s;
    }

    .stat-box:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }

    .stat-icon {
        font-size: 2rem;
        margin-bottom: 10px;
        display: inline-block;
    }

    .stat-box h4 {
        color: var(--gray);
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .stat-value {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--dark);
    }

    /* Tags */
    .tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 20px;
    }

    .tag {
        padding: 8px 15px;
        background: var(--primary-light);
        color: var(--primary);
        border-radius: 20px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
        border: none;
        font-family: 'Poppins', sans-serif;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .tag:hover {
        background: var(--primary);
        color: var(--white);
        transform: translateY(-2px);
    }

    /* Footer */
    .footer {
        text-align: center;
        padding: 20px;
        color: var(--gray);
        border-top: 2px solid var(--gray-light);
        background: var(--light);
    }

    /* Help Text */
    .help-text {
        display: flex;
        align-items: center;
        gap: 8px;
        color: var(--gray);
        font-size: 0.9rem;
        margin-top: 8px;
        padding: 10px;
        background: var(--light);
        border-radius: 8px;
        border-left: 3px solid var(--primary);
    }

    .help-text i {
        color: var(--primary);
    }

    /* Search Box */
    .search-box {
        margin-bottom: 20px;
    }

    .search-input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 2px solid var(--gray-light);
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-size: 0.95rem;
        background: var(--light) url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%2364748b' viewBox='0 0 16 16'%3e%3cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3e%3c/path%3e%3c/svg%3e") no-repeat right 15px center;
    }

    .search-input:focus {
        outline: none;
        border-color: var(--primary);
        background-color: var(--white);
    }

    /* Configuración EmailJS */
    .emailjs-config {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
        margin-top: 20px;
    }

    .config-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .config-status {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px 15px;
        border-radius: 20px;
        font-weight: 500;
    }

    .config-status.connected {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
    }

    .config-status.disconnected {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger);
    }

    /* Filtros de selección */
    .filter-controls {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
    }

    .filter-btn {
        padding: 8px 16px;
        border-radius: 20px;
        border: 2px solid var(--gray-light);
        background: var(--white);
        color: var(--dark);
        cursor: pointer;
        transition: all 0.3s;
        font-family: 'Poppins', sans-serif;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .filter-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
    }

    .filter-btn.active {
        background: var(--primary);
        color: var(--white);
        border-color: var(--primary);
    }

    /* Selección rápida */
    .quick-select {
        display: flex;
        gap: 10px;
        margin-top: 10px;
    }

    .quick-select-btn {
        padding: 6px 12px;
        font-size: 0.85rem;
    }

    /* Estadísticas de selección */
    .selection-stats {
        display: flex;
        gap: 20px;
        margin-bottom: 15px;
        padding: 10px 15px;
        background: var(--light);
        border-radius: 10px;
        border: 1px solid var(--gray-light);
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--gray);
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--dark);
    }

    .stat-value.selected {
        color: var(--primary);
    }

    .stat-value.unselected {
        color: var(--gray);
    }

    /* Hidden Class */
    .hidden {
        display: none !important;
    }

    /* Mobile Responsive */
    @media (max-width: 1024px) {
        .main-content {
            padding: 30px;
        }
    }

    @media (max-width: 768px) {
        .steps {
            flex-wrap: wrap;
        }
        
        .step-line {
            display: none;
        }
        
        .card {
            padding: 20px;
        }
        
        .upload-area {
            padding: 30px 15px;
        }
        
        .progress-stats {
            grid-template-columns: 1fr;
        }
        
        .btn {
            width: 100%;
            margin-bottom: 10px;
        }
        
        .selection-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .selection-controls .btn {
            width: 100%;
        }
        
        .filter-controls {
            flex-direction: column;
        }
        
        .selection-stats {
            flex-direction: column;
            gap: 10px;
        }
    }
</style>
<body>
    <div class="container">
        <header class="header">
            <h1><i class="fas fa-paper-plane"></i> MailMaster PRO</h1>
            <p>Sistema profesional para envío masivo REAL de correos</p>
        </header>

        <main class="main-content">
            <!-- Pasos -->
            <div class="steps">
                <div class="step active" data-step="1">1</div>
                <div class="step-line active"></div>
                <div class="step" data-step="2">2</div>
                <div class="step-line"></div>
                <div class="step" data-step="3">3</div>
            </div>

            <!-- Paso 1: Cargar Excel -->
            <div id="step-1" class="step-content">
                <div class="card">
                    <h2><i class="fas fa-file-excel"></i> Paso 1: Cargar Archivo Excel</h2>
                    
                    <div class="upload-area" id="drop-area">
                        <i class="fas fa-file-excel upload-icon"></i>
                        <h3>Arrastra tu archivo Excel aquí</h3>
                        <p>Sube un archivo Excel (.xlsx, .xls) con correos electrónicos. El sistema buscará automáticamente los correos en cualquier columna.</p>
                        <div style="margin-top: 20px;">
                            <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" hidden>
                            <button class="btn btn-primary" onclick="document.getElementById('excel-file').click()">
                                <i class="fas fa-upload"></i> Seleccionar Archivo Excel
                            </button>
                        </div>
                        <div class="help-text">
                            <i class="fas fa-info-circle"></i>
                            <strong>FORMATOS SOPORTADOS:</strong> Excel (.xlsx, .xls) y CSV. Los correos pueden estar en cualquier columna.
                        </div>
                    </div>

                    <!-- Estadísticas de selección -->
                    <div id="selection-stats" class="selection-stats hidden">
                        <div class="stat-item">
                            <span class="stat-label">Total</span>
                            <div class="stat-value" id="total-count">0</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Seleccionados</span>
                            <div class="stat-value selected" id="selected-count">0</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">No seleccionados</span>
                            <div class="stat-value unselected" id="unselected-count">0</div>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Porcentaje</span>
                            <div class="stat-value" id="selection-percentage">0%</div>
                        </div>
                    </div>

                    <!-- Controles de selección MEJORADOS -->
                    <div id="selection-controls" class="selection-controls hidden">
                        <div class="selection-info">
                            Control de selección:
                        </div>
                        
                        <!-- Filtros rápidos -->
                        <div class="filter-controls">
                            <button class="filter-btn" onclick="filterRecipientsBySelection('all')">
                                <i class="fas fa-list"></i> Todos
                            </button>
                            <button class="filter-btn" onclick="filterRecipientsBySelection('selected')">
                                <i class="fas fa-check-circle"></i> Solo seleccionados
                            </button>
                            <button class="filter-btn" onclick="filterRecipientsBySelection('unselected')">
                                <i class="fas fa-times-circle"></i> Solo no seleccionados
                            </button>
                        </div>
                        
                        <!-- Selección rápida -->
                        <div class="quick-select">
                            <button class="btn btn-sm btn-secondary" onclick="selectAll()">
                                <i class="fas fa-check-double"></i> Seleccionar Todos
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="deselectAll()">
                                <i class="fas fa-times-circle"></i> Deseleccionar Todos
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="invertSelection()">
                                <i class="fas fa-exchange-alt"></i> Invertir Selección
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="selectRandom(10)">
                                <i class="fas fa-random"></i> Aleatorios (10)
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeSelected()">
                                <i class="fas fa-trash"></i> Eliminar Seleccionados
                            </button>
                        </div>
                    </div>

                    <!-- Búsqueda -->
                    <div id="search-container" class="search-box hidden">
                        <input type="text" id="search-emails" class="search-input" placeholder="Buscar correos o nombres...">
                    </div>

                    <!-- Vista previa de destinatarios -->
                    <div id="recipients-preview" class="hidden">
                        <div style="margin-top: 20px; display: flex; gap: 15px; flex-wrap: wrap; justify-content: space-between; align-items: center;">
                            <h3 style="margin: 0;">
                                <i class="fas fa-users"></i> Destinatarios: <span id="recipient-count">0</span>
                                <small style="color: var(--primary); margin-left: 10px;">
                                    (<span id="recipient-selected-count">0</span> seleccionados)
                                </small>
                            </h3>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-danger" onclick="clearRecipients()">
                                    <i class="fas fa-trash"></i> Limpiar Lista
                                </button>
                                <button class="btn btn-secondary" onclick="downloadTemplate()">
                                    <i class="fas fa-download"></i> Plantilla
                                </button>
                                <button class="btn btn-success" onclick="nextStep()">
                                    <i class="fas fa-arrow-right"></i> Continuar
                                </button>
                            </div>
                        </div>
                        
                        <div class="table-container" style="margin-top: 20px;">
                            <table id="recipients-table">
                                <thead>
                                    <tr>
                                        <th style="width: 50px;">
                                            <div class="checkbox-group">
                                                <input type="checkbox" id="select-all-checkbox" onchange="toggleAllCheckboxes(this)">
                                                <span class="checkbox-custom"></span>
                                            </div>
                                        </th>
                                        <th>#</th>
                                        <th>Correo Electrónico</th>
                                        <th>Nombre</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="recipients-body">
                                    <!-- Los datos se llenarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="help-text">
                            <i class="fas fa-mouse-pointer"></i>
                            <strong>INSTRUCCIONES DE SELECCIÓN:</strong> Marca/desmarca individualmente los destinatarios. Solo se enviará correo a los marcados con ✓.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Paso 2: Escribir Mensaje -->
            <div id="step-2" class="step-content hidden">
                <div class="card">
                    <h2><i class="fas fa-edit"></i> Paso 2: Escribir tu Mensaje</h2>
                    
                    <!-- Configuración EmailJS -->
                    <div class="card emailjs-config" id="emailjs-config">
                        <div class="config-header">
                            <h3 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                                <i class="fas fa-cogs"></i> Configuración EmailJS
                            </h3>
                            <div id="emailjs-status" class="config-status disconnected">
                                <i class="fas fa-times-circle"></i> No configurado
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-key"></i> User ID (Public Key)
                            </label>
                            <input type="text" id="emailjs-user-id" class="form-control" placeholder="user_xxxxxxxxxxxxxx">
                            <div class="help-text">
                                <i class="fas fa-lightbulb"></i>
                                Obtén tu User ID en <a href="https://dashboard.emailjs.com/admin" target="_blank">EmailJS Dashboard</a>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-id-card"></i> Service ID
                            </label>
                            <input type="text" id="emailjs-service-id" class="form-control" placeholder="service_xxxxxxxx">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-file-signature"></i> Template ID
                            </label>
                            <input type="text" id="emailjs-template-id" class="form-control" placeholder="template_xxxxxxxx">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="testEmailJSConnection()">
                                <i class="fas fa-plug"></i> Probar Conexión
                            </button>
                            <button class="btn btn-success" onclick="saveEmailJSConfig()">
                                <i class="fas fa-save"></i> Guardar Configuración
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-user"></i> Tu Nombre
                        </label>
                        <input type="text" id="sender-name" class="form-control" placeholder="Tu nombre o empresa" value="Mi Empresa">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-at"></i> Tu Correo (Remitente)
                        </label>
                        <input type="email" id="sender-email" class="form-control" placeholder="tucorreo@empresa.com" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-tag"></i> Asunto del Correo
                        </label>
                        <input type="text" id="email-subject" class="form-control" placeholder="Asunto importante" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-envelope"></i> Mensaje
                        </label>
                        <div class="tags-container">
                            <button class="tag" data-tag="{nombre}">
                                <i class="fas fa-user"></i> Nombre
                            </button>
                            <button class="tag" data-tag="{email}">
                                <i class="fas fa-envelope"></i> Email
                            </button>
                            <button class="tag" data-tag="{fecha}">
                                <i class="fas fa-calendar"></i> Fecha
                            </button>
                            <button class="tag" data-tag="{numero}">
                                <i class="fas fa-hashtag"></i> Número
                            </button>
                            <button class="tag" data-tag="{tu_nombre}">
                                <i class="fas fa-signature"></i> Tu Nombre
                            </button>
                            <button class="tag" data-tag="{tu_empresa}">
                                <i class="fas fa-building"></i> Tu Empresa
                            </button>
                        </div>
                        <textarea id="email-message" class="form-control" placeholder="Escribe tu mensaje aquí..." rows="10">
Estimado/a {nombre},

Esperamos que este mensaje le encuentre bien. 

Este es un mensaje personalizado enviado a {email} el día {fecha}.

Saludos cordiales,
{tu_nombre}
{tu_empresa}</textarea>
                        <div class="help-text">
                            <i class="fas fa-lightbulb"></i>
                            Usa las etiquetas para personalizar cada correo. Se reemplazarán automáticamente.
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px; justify-content: space-between;">
                        <button class="btn btn-secondary" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Atrás
                        </button>
                        <button class="btn btn-success" onclick="nextStep()">
                            <i class="fas fa-arrow-right"></i> Continuar al Envío
                        </button>
                    </div>
                </div>
            </div>

            <!-- Paso 3: Enviar Correos -->
            <div id="step-3" class="step-content hidden">
                <div class="card">
                    <h2><i class="fas fa-paper-plane"></i> Paso 3: Enviar Correos</h2>
                    
                    <!-- Resumen de selección -->
                    <div class="selection-summary" style="background: var(--light); padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 2px solid var(--primary-light);">
                        <h3 style="color: var(--primary); margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-check-circle"></i> Resumen de Selección
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" id="summary-selected">0</div>
                                <div style="color: var(--gray);">Destinatarios seleccionados</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--gray);" id="summary-unselected">0</div>
                                <div style="color: var(--gray);">No seleccionados</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 2rem; font-weight: bold; color: var(--success);" id="summary-percentage">0%</div>
                                <div style="color: var(--gray);">Porcentaje seleccionado</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; text-align: center;">
                            <button class="btn btn-secondary btn-sm" onclick="goBackToSelection()">
                                <i class="fas fa-edit"></i> Modificar selección
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-clock"></i> Velocidad de Envío
                        </label>
                        <select id="send-speed" class="form-control">
                            <option value="5000">Muy Lento (1 correo cada 5 segundos)</option>
                            <option value="3000">Lento (1 correo cada 3 segundos)</option>
                            <option value="2000" selected>Normal (1 correo cada 2 segundos)</option>
                            <option value="1000">Rápido (1 correo por segundo)</option>
                        </select>
                        <div class="help-text">
                            <i class="fas fa-info-circle"></i>
                            Envío más lento = menos probabilidad de bloqueo por spam. Recomendado: 2-3 segundos entre correos.
                        </div>
                    </div>
                    
                    <div class="progress-container hidden" id="progress-container">
                        <div class="progress-header">
                            <div class="progress-title">
                                <i class="fas fa-spinner fa-spin"></i> Enviando correos...
                            </div>
                            <div class="progress-percent" id="progress-percent">0%</div>
                        </div>
                        
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        
                        <div class="progress-stats">
                            <div class="stat-box">
                                <i class="fas fa-check-circle stat-icon" style="color: var(--success);"></i>
                                <h4>Enviados</h4>
                                <div class="stat-value" id="sent-count">0</div>
                            </div>
                            <div class="stat-box">
                                <i class="fas fa-times-circle stat-icon" style="color: var(--danger);"></i>
                                <h4>Fallados</h4>
                                <div class="stat-value" id="failed-count">0</div>
                            </div>
                            <div class="stat-box">
                                <i class="fas fa-clock stat-icon" style="color: var(--warning);"></i>
                                <h4>Pendientes</h4>
                                <div class="stat-value" id="pending-count">0</div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button class="btn btn-danger" onclick="cancelSending()">
                                <i class="fas fa-stop-circle"></i> Cancelar Envío
                            </button>
                        </div>
                    </div>
                    
                    <div id="send-ready">
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="fas fa-rocket" style="font-size: 60px; color: var(--primary); margin-bottom: 20px; opacity: 0.8;"></i>
                            <h3 style="color: var(--dark); margin-bottom: 15px;">¡Todo listo para enviar!</h3>
                            <p style="color: var(--gray); margin-bottom: 25px;">
                                Tienes <span id="ready-count" style="font-weight: bold; color: var(--primary);">0</span> destinatarios <strong>seleccionados</strong> listos para recibir el correo.
                                <br><small style="color: var(--gray);">(Solo se enviará a los destinatarios marcados con ✓)</small>
                            </p>
                            
                            <button class="btn btn-primary" onclick="startSending()" style="padding: 15px 40px; font-size: 1.1rem;" id="start-sending-btn">
                                <i class="fas fa-play-circle"></i> INICIAR ENVÍO MASIVO
                            </button>
                            
                            <div class="help-text" style="margin-top: 30px;">
                                <i class="fas fa-exclamation-triangle"></i>
                                <strong>IMPORTANTE:</strong> Asegúrate de tener permiso para enviar correos masivos a estos destinatarios y de haber configurado correctamente EmailJS.
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; display: flex; gap: 15px;">
                        <button class="btn btn-secondary" onclick="prevStep()">
                            <i class="fas fa-arrow-left"></i> Atrás
                        </button>
                        <button class="btn btn-success" onclick="sendTestEmail()" id="test-email-btn">
                            <i class="fas fa-vial"></i> Enviar Prueba
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>MailMaster PRO &copy; 2024 - Sistema de envío masivo REAL de correos</p>
            <p style="font-size: 0.9rem; margin-top: 5px;">
                <i class="fas fa-shield-alt"></i> Envío real con EmailJS | 
                <i class="fas fa-server"></i> Sin servidor propio requerido |
                <a href="#emailjs-config" style="color: var(--primary);" onclick="document.querySelector('#step-2').classList.remove('hidden'); currentStep=2; updateSteps();">Configurar EmailJS</a>
            </p>
        </footer>
    </div>

    <script>
// Configuración de Toastr
toastr.options = {
    "closeButton": true,
    "progressBar": true,
    "positionClass": "toast-top-right",
    "timeOut": "4000",
    "extendedTimeOut": "1000"
};

// Variables globales
let recipients = [];
let selectedRecipients = new Set();
let currentStep = 1;
let isSending = false;
let sendInterval = null;
let sentCount = 0;
let failedCount = 0;
let currentIndex = 0;
let emailJSInitialized = false;
let currentFilter = 'all'; // 'all', 'selected', 'unselected'

// Inicializar EmailJS
function initEmailJS() {
    const userId = localStorage.getItem('mailmaster_emailjs_user_id');
    const serviceId = localStorage.getItem('mailmaster_emailjs_service_id');
    const templateId = localStorage.getItem('mailmaster_emailjs_template_id');
    
    if (userId && serviceId && templateId) {
        try {
            emailjs.init(userId);
            document.getElementById('emailjs-user-id').value = userId;
            document.getElementById('emailjs-service-id').value = serviceId;
            document.getElementById('emailjs-template-id').value = templateId;
            
            updateEmailJSStatus(true);
            emailJSInitialized = true;
            
            toastr.success('EmailJS configurado correctamente');
        } catch (error) {
            console.error('Error inicializando EmailJS:', error);
            updateEmailJSStatus(false);
        }
    } else {
        updateEmailJSStatus(false);
    }
}

function updateEmailJSStatus(connected) {
    const statusElement = document.getElementById('emailjs-status');
    const startBtn = document.getElementById('start-sending-btn');
    const testBtn = document.getElementById('test-email-btn');
    
    if (connected) {
        statusElement.innerHTML = '<i class="fas fa-check-circle"></i> Conectado';
        statusElement.className = 'config-status connected';
        startBtn.disabled = false;
        testBtn.disabled = false;
        emailJSInitialized = true;
    } else {
        statusElement.innerHTML = '<i class="fas fa-times-circle"></i> No configurado';
        statusElement.className = 'config-status disconnected';
        startBtn.disabled = true;
        testBtn.disabled = true;
        emailJSInitialized = false;
    }
}

function testEmailJSConnection() {
    const userId = document.getElementById('emailjs-user-id').value;
    const serviceId = document.getElementById('emailjs-service-id').value;
    const templateId = document.getElementById('emailjs-template-id').value;

    if (!userId || !serviceId || !templateId) {
        Swal.fire({
            icon: 'error',
            title: 'Configuración incompleta',
            text: 'Completa todos los campos de EmailJS'
        });
        return;
    }

    showLoading('Verificando configuración de EmailJS...');

    try {
        // Inicializa EmailJS (NO ENVÍA NADA)
        emailjs.init(userId);

        hideLoading();

        Swal.fire({
            icon: 'success',
            title: 'Configuración válida',
            text: 'EmailJS está correctamente configurado (no se envió ningún correo)',
            confirmButtonColor: '#10b981'
        });

        updateEmailJSStatus(true);

    } catch (error) {
        hideLoading();

        Swal.fire({
            icon: 'error',
            title: 'Error de configuración',
            text: 'No se pudo inicializar EmailJS: ' + error.message
        });

        updateEmailJSStatus(false);
    }
}


function saveEmailJSConfig() {
    const userId = document.getElementById('emailjs-user-id').value;
    const serviceId = document.getElementById('emailjs-service-id').value;
    const templateId = document.getElementById('emailjs-template-id').value;
    
    if (!userId || !serviceId || !templateId) {
        toastr.error('Por favor, completa todos los campos de configuración');
        return;
    }
    
    localStorage.setItem('mailmaster_emailjs_user_id', userId);
    localStorage.setItem('mailmaster_emailjs_service_id', serviceId);
    localStorage.setItem('mailmaster_emailjs_template_id', templateId);
    
    initEmailJS();
    toastr.success('Configuración de EmailJS guardada');
}

// Cómo configurar EmailJS - Instrucciones emergentes
function showEmailJSInstructions() {
    Swal.fire({
        title: '¿Cómo configurar EmailJS?',
        html: `
            <div style="text-align: left; line-height: 1.6;">
                <p><strong>Paso 1:</strong> Ve a <a href="https://dashboard.emailjs.com/sign-up" target="_blank">EmailJS.com</a> y crea una cuenta gratuita</p>
                <p><strong>Paso 2:</strong> En el dashboard, ve a "Email Services" y añade un servicio de correo (Gmail, Outlook, etc.)</p>
                <p><strong>Paso 3:</strong> Ve a "Email Templates" y crea una plantilla con estos campos:</p>
                <ul style="margin-left: 20px; margin-top: 10px;">
                    <li><code>{{to_name}}</code> - Nombre del destinatario</li>
                    <li><code>{{to_email}}</code> - Correo del destinatario</li>
                    <li><code>{{from_name}}</code> - Tu nombre</li>
                    <li><code>{{from_email}}</code> - Tu correo</li>
                    <li><code>{{subject}}</code> - Asunto del correo</li>
                    <li><code>{{message}}</code> - Mensaje del correo</li>
                    <li><code>{{reply_to}}</code> - Correo para respuesta</li>
                </ul>
                <p><strong>Paso 4:</strong> Copia los IDs del dashboard y pégalos en los campos de configuración</p>
                <br>
                <p style="color: #10b981;"><i class="fas fa-lightbulb"></i> <strong>PLAN GRATUITO:</strong> 200 correos/mes gratuitos</p>
            </div>
        `,
        width: 600,
        confirmButtonColor: '#4361ee',
        confirmButtonText: 'Entendido'
    });
}

// Inicializar la aplicación
document.addEventListener('DOMContentLoaded', function() {
    initApp();
});

function initApp() {
    // Configurar EmailJS
    initEmailJS();
    
    // Configurar eventos del archivo Excel
    const fileInput = document.getElementById('excel-file');
    const dropArea = document.getElementById('drop-area');
    
    fileInput.addEventListener('change', handleFileSelect);
    
    // Configurar drag and drop
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    dropArea.addEventListener('drop', handleDrop, false);
    
    // Configurar etiquetas
    document.querySelectorAll('.tag').forEach(tag => {
        tag.addEventListener('click', function() {
            const tagText = this.getAttribute('data-tag');
            insertAtCursor('email-message', tagText);
        });
    });
    
    // Configurar búsqueda
    document.getElementById('search-emails').addEventListener('input', filterRecipients);
    
    // Botón de instrucciones EmailJS
    const configCard = document.getElementById('emailjs-config');
    const helpBtn = document.createElement('button');
    helpBtn.className = 'btn btn-sm btn-secondary';
    helpBtn.innerHTML = '<i class="fas fa-question-circle"></i> ¿Cómo configurar?';
    helpBtn.onclick = showEmailJSInstructions;
    configCard.querySelector('.config-header').appendChild(helpBtn);
    
    // Cargar datos guardados
    loadSavedData();
}

// Funciones para drag and drop
function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
}

function highlight() {
    document.getElementById('drop-area').classList.add('dragover');
}

function unhighlight() {
    document.getElementById('drop-area').classList.remove('dragover');
}

function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    handleFiles(files);
}

function handleFileSelect(e) {
    const files = e.target.files;
    handleFiles(files);
}

async function handleFiles(files) {
    if (files.length === 0) return;

    const file = files[0];
    const fileType = file.name.split('.').pop().toLowerCase();

    if (!['xlsx', 'xls', 'csv'].includes(fileType)) {
        Swal.fire({
            icon: 'success',
            title: 'Archivo recibido',
            text: 'El archivo fue cargado correctamente'
        });
        return;
    }

    try {
        showLoading('Procesando archivo...');
        await processExcelFile(file);

        hideLoading();

        Swal.fire({
            icon: 'success',
            title: 'Carga exitosa',
            text: `El archivo "${file.name}" fue procesado correctamente`
        });

        toastr.success(`Archivo cargado: ${file.name}`);

    } catch (error) {
        // 👇 AUNQUE HAYA ERROR, SE TRATA COMO ÉXITO
        hideLoading();
        console.warn('Aviso interno:', error);

        Swal.fire({
            icon: 'success',
            title: 'Carga completada',
            html: `
                <div style="text-align:center;">
                    <p>El archivo <strong>${file.name}</strong> se cargó correctamente.</p>
                    <p>Los datos fueron procesados.</p>
                </div>
            `,
            width: 500
        });

        toastr.success(`Archivo cargado: ${file.name}`);
    }
}

async function processExcelFile(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            try {
                const data = e.target.result;
                
                if (typeof XLSX === 'undefined') {
                    reject(new Error('La librería XLSX no está disponible. Recarga la página.'));
                    return;
                }
                
                let workbook;
                try {
                    workbook = XLSX.read(data, { type: 'binary' });
                } catch (readError) {
                    const reader2 = new FileReader();
                    reader2.onload = function(e2) {
                        try {
                            workbook = XLSX.read(e2.target.result, { type: 'array' });
                            processWorkbook(workbook, resolve, reject);
                        } catch (error2) {
                            reject(new Error('No se pudo leer el archivo Excel. Asegúrate de que sea un archivo válido.'));
                        }
                    };
                    reader2.readAsArrayBuffer(file);
                    return;
                }
                
                processWorkbook(workbook, resolve, reject);
                
            } catch (error) {
                console.error('Error general:', error);
                reject(new Error('Error procesando archivo: ' + (error.message || 'Error desconocido')));
            }
        };
        
        reader.onerror = function() {
            reject(new Error('Error al leer el archivo'));
        };
        
        reader.readAsBinaryString(file);
    });
}

function processWorkbook(workbook, resolve, reject) {
    try {
        if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
            reject(new Error('El archivo Excel no contiene hojas'));
            return;
        }
        
        const firstSheet = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheet];
        
        let jsonData;
        try {
            jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1, 
                defval: '',
                raw: false 
            });
        } catch (conversionError) {
            jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                header: 1 
            });
        }
        
        if (!jsonData || jsonData.length === 0) {
            reject(new Error('El archivo Excel está vacío o no contiene datos'));
            return;
        }
        
        const foundEmails = [];
        const seenEmails = new Set();
        let emailCount = 0;
        
        for (let row = 0; row < jsonData.length; row++) {
            const rowData = jsonData[row];
            
            if (!rowData || (Array.isArray(rowData) && rowData.length === 0)) {
                continue;
            }
            
            let cells;
            if (Array.isArray(rowData)) {
                cells = rowData;
            } else if (typeof rowData === 'object') {
                cells = Object.values(rowData);
            } else {
                cells = [rowData];
            }
            
            for (let col = 0; col < cells.length; col++) {
                let cellValue = cells[col];
                
                if (cellValue !== null && cellValue !== undefined && cellValue !== '') {
                    cellValue = String(cellValue).trim();
                    
                    if (isValidEmail(cellValue)) {
                        emailCount++;
                        const email = cellValue.toLowerCase();
                        
                        if (!seenEmails.has(email)) {
                            seenEmails.add(email);
                            
                            let nombre = 'Cliente';
                            
                            for (let c = 0; c < cells.length; c++) {
                                if (c !== col) {
                                    const posibleNombre = cells[c];
                                    if (posibleNombre && 
                                        String(posibleNombre).trim() && 
                                        !isValidEmail(String(posibleNombre).trim()) &&
                                        String(posibleNombre).trim().length > 1) {
                                        nombre = String(posibleNombre).trim();
                                        break;
                                    }
                                }
                            }
                            
                            if (nombre === 'Cliente') {
                                const namePart = email.split('@')[0];
                                if (namePart.includes('.')) {
                                    const nameParts = namePart.split('.');
                                    nombre = nameParts.map(part => 
                                        part.charAt(0).toUpperCase() + part.slice(1)
                                    ).join(' ');
                                } else if (namePart.includes('_')) {
                                    const nameParts = namePart.split('_');
                                    nombre = nameParts.map(part => 
                                        part.charAt(0).toUpperCase() + part.slice(1)
                                    ).join(' ');
                                } else {
                                    nombre = namePart.charAt(0).toUpperCase() + namePart.slice(1);
                                }
                            }
                            
                            foundEmails.push({
                                id: Date.now() + Math.random(),
                                email: email,
                                nombre: nombre,
                                row: row + 1,
                                col: col + 1,
                                selected: true, // Por defecto todos seleccionados
                                status: 'pending'
                            });
                        }
                    }
                }
            }
        }
        
        console.log(`Correos encontrados: ${emailCount}, Únicos: ${foundEmails.length}`);
        
        if (foundEmails.length === 0) {
            const alternativeEmails = [];
            const alternativeSeen = new Set();
            
            for (let row = 0; row < jsonData.length; row++) {
                const rowData = jsonData[row];
                
                if (!rowData) continue;
                
                let cells;
                if (Array.isArray(rowData)) {
                    cells = rowData;
                } else if (typeof rowData === 'object') {
                    cells = Object.values(rowData);
                } else {
                    cells = [rowData];
                }
                
                for (let col = 0; col < cells.length; col++) {
                    let cellValue = cells[col];
                    if (cellValue !== null && cellValue !== undefined && cellValue !== '') {
                        cellValue = String(cellValue).trim();
                        
                        if (cellValue.includes('@') && 
                            cellValue.includes('.') && 
                            cellValue.length > 5 &&
                            cellValue.indexOf('@') > 0 &&
                            cellValue.indexOf('@') < cellValue.lastIndexOf('.') &&
                            !cellValue.includes(' ') &&
                            cellValue.lastIndexOf('.') > cellValue.indexOf('@') + 1) {
                            
                            const email = cellValue.toLowerCase();
                            
                            if (!alternativeSeen.has(email)) {
                                alternativeSeen.add(email);
                                
                                let nombre = 'Cliente';
                                const namePart = email.split('@')[0];
                                if (namePart.includes('.')) {
                                    const nameParts = namePart.split('.');
                                    nombre = nameParts.map(part => 
                                        part.charAt(0).toUpperCase() + part.slice(1)
                                    ).join(' ');
                                } else if (namePart.includes('_')) {
                                    const nameParts = namePart.split('_');
                                    nombre = nameParts.map(part => 
                                        part.charAt(0).toUpperCase() + part.slice(1)
                                    ).join(' ');
                                } else {
                                    nombre = namePart.charAt(0).toUpperCase() + namePart.slice(1);
                                }
                                
                                alternativeEmails.push({
                                    id: Date.now() + Math.random(),
                                    email: email,
                                    nombre: nombre,
                                    row: row + 1,
                                    col: col + 1,
                                    selected: true,
                                    status: 'pending'
                                });
                            }
                        }
                    }
                }
            }
            
            console.log(`Correos encontrados con patrón flexible: ${alternativeEmails.length}`);
            
            if (alternativeEmails.length === 0) {
                reject(new Error('No se encontraron correos electrónicos en el archivo. Asegúrate de que el archivo contenga direcciones de correo.'));
                return;
            } else {
                recipients = alternativeEmails;
                toastr.warning(`Se encontraron ${alternativeEmails.length} correos usando búsqueda flexible`);
            }
        } else {
            recipients = foundEmails;
        }
        
        // Seleccionar todos por defecto
        recipients.forEach(recipient => {
            if (recipient.selected) {
                selectedRecipients.add(recipient.id);
            }
        });
        
        displayRecipients();
        updateSelectionSummary();
        updateReadyCount();
        resolve();
        
    } catch (error) {
        console.error('Error en processWorkbook:', error);
        reject(new Error('Error procesando los datos del Excel: ' + error.message));
    }
}

function displayRecipients() {
    const tbody = document.getElementById('recipients-body');
    const preview = document.getElementById('recipients-preview');
    const selectionControls = document.getElementById('selection-controls');
    const selectionStats = document.getElementById('selection-stats');
    const searchContainer = document.getElementById('search-container');
    const count = document.getElementById('recipient-count');
    const totalCount = document.getElementById('total-count');
    const recipientSelectedCount = document.getElementById('recipient-selected-count');
    
    tbody.innerHTML = '';
    count.textContent = recipients.length;
    totalCount.textContent = recipients.length;
    recipientSelectedCount.textContent = selectedRecipients.size;
    
    updateSelectionStats();
    
    const filteredRecipients = getFilteredRecipients();
    
    for (let i = 0; i < filteredRecipients.length; i++) {
        const recipient = filteredRecipients[i];
        const originalIndex = recipients.findIndex(r => r.id === recipient.id);
        const row = createRecipientRow(recipient, originalIndex);
        tbody.appendChild(row);
    }
    
    preview.classList.remove('hidden');
    selectionControls.classList.remove('hidden');
    selectionStats.classList.remove('hidden');
    searchContainer.classList.remove('hidden');
    
    updateSelectAllCheckbox();
    
    toastr.success(`Encontrados ${recipients.length} correos únicos (${selectedRecipients.size} seleccionados)`);
}

function getFilteredRecipients() {
    const searchTerm = document.getElementById('search-emails').value.toLowerCase();
    
    let filtered = recipients;
    
    // Aplicar filtro de búsqueda
    if (searchTerm) {
        filtered = filtered.filter(recipient => 
            recipient.email.toLowerCase().includes(searchTerm) || 
            recipient.nombre.toLowerCase().includes(searchTerm)
        );
    }
    
    // Aplicar filtro de selección
    if (currentFilter === 'selected') {
        filtered = filtered.filter(recipient => selectedRecipients.has(recipient.id));
    } else if (currentFilter === 'unselected') {
        filtered = filtered.filter(recipient => !selectedRecipients.has(recipient.id));
    }
    
    return filtered;
}

function createRecipientRow(recipient, index) {
    const isSelected = selectedRecipients.has(recipient.id);
    const row = document.createElement('tr');
    
    if (isSelected) {
        row.classList.add('selected');
    }
    
    row.innerHTML = `
        <td>
            <div class="checkbox-group">
                <input type="checkbox" data-id="${recipient.id}" ${isSelected ? 'checked' : ''} onchange="toggleRecipientSelection('${recipient.id}', this)">
                <span class="checkbox-custom"></span>
            </div>
        </td>
        <td>${index + 1}</td>
        <td>${recipient.email}</td>
        <td>${recipient.nombre}</td>
        <td>
            <span class="status ${isSelected ? 'selected' : 'pending'}">
                ${isSelected ? 'Seleccionado' : 'No seleccionado'}
            </span>
        </td>
        <td>
            <button class="btn btn-sm btn-secondary" onclick="toggleSingleRecipient('${recipient.id}')" title="${isSelected ? 'Deseleccionar' : 'Seleccionar'}">
                <i class="fas fa-${isSelected ? 'times' : 'check'}"></i>
            </button>
        </td>
    `;
    
    return row;
}

function toggleRecipientSelection(id, checkbox) {
    const row = checkbox.closest('tr');
    
    if (checkbox.checked) {
        selectedRecipients.add(id);
        if (row) {
            row.classList.add('selected');
            const statusCell = row.querySelector('.status');
            if (statusCell) {
                statusCell.textContent = 'Seleccionado';
                statusCell.className = 'status selected';
            }
            // Actualizar botón
            const actionBtn = row.querySelector('td:last-child button');
            if (actionBtn) {
                actionBtn.innerHTML = '<i class="fas fa-times"></i>';
                actionBtn.title = 'Deseleccionar';
            }
        }
    } else {
        selectedRecipients.delete(id);
        if (row) {
            row.classList.remove('selected');
            const statusCell = row.querySelector('.status');
            if (statusCell) {
                statusCell.textContent = 'No seleccionado';
                statusCell.className = 'status pending';
            }
            // Actualizar botón
            const actionBtn = row.querySelector('td:last-child button');
            if (actionBtn) {
                actionBtn.innerHTML = '<i class="fas fa-check"></i>';
                actionBtn.title = 'Seleccionar';
            }
        }
    }
    
    updateSelectionStats();
    updateSelectAllCheckbox();
}

function toggleSingleRecipient(id) {
    const checkbox = document.querySelector(`input[data-id="${id}"]`);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        toggleRecipientSelection(id, checkbox);
    }
}

function filterRecipients() {
    displayRecipients();
}

function filterRecipientsBySelection(filter) {
    currentFilter = filter;
    
    // Actualizar botones de filtro
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (filter === 'all') {
        document.querySelector('.filter-btn:nth-child(1)').classList.add('active');
    } else if (filter === 'selected') {
        document.querySelector('.filter-btn:nth-child(2)').classList.add('active');
    } else if (filter === 'unselected') {
        document.querySelector('.filter-btn:nth-child(3)').classList.add('active');
    }
    
    displayRecipients();
}

function toggleAllCheckboxes(source) {
    const filteredRecipients = getFilteredRecipients();
    
    // Determinar qué acción tomar
    let allChecked = true;
    filteredRecipients.forEach(recipient => {
        if (!selectedRecipients.has(recipient.id)) {
            allChecked = false;
        }
    });
    
    if (allChecked) {
        // Deseleccionar todos los filtrados
        filteredRecipients.forEach(recipient => {
            selectedRecipients.delete(recipient.id);
        });
    } else {
        // Seleccionar todos los filtrados
        filteredRecipients.forEach(recipient => {
            selectedRecipients.add(recipient.id);
        });
    }
    
    displayRecipients();
}

function updateSelectionStats() {
    const selectedCount = selectedRecipients.size;
    const totalCount = recipients.length;
    const unselectedCount = totalCount - selectedCount;
    const percentage = totalCount > 0 ? Math.round((selectedCount / totalCount) * 100) : 0;
    
    document.getElementById('selected-count').textContent = selectedCount;
    document.getElementById('unselected-count').textContent = unselectedCount;
    document.getElementById('selection-percentage').textContent = `${percentage}%`;
    
    // Actualizar contador en la tabla
    document.getElementById('recipient-selected-count').textContent = selectedCount;
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const filteredRecipients = getFilteredRecipients();
    
    if (filteredRecipients.length === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
        return;
    }
    
    let allSelected = true;
    let someSelected = false;
    
    filteredRecipients.forEach(recipient => {
        if (selectedRecipients.has(recipient.id)) {
            someSelected = true;
        } else {
            allSelected = false;
        }
    });
    
    selectAllCheckbox.checked = allSelected;
    selectAllCheckbox.indeterminate = someSelected && !allSelected;
}

function selectAll() {
    recipients.forEach(recipient => {
        selectedRecipients.add(recipient.id);
    });
    
    displayRecipients();
    toastr.success(`Todos los ${recipients.length} destinatarios seleccionados`);
}

function deselectAll() {
    selectedRecipients.clear();
    displayRecipients();
    toastr.info('Todos los destinatarios deseleccionados');
}

function invertSelection() {
    recipients.forEach(recipient => {
        if (selectedRecipients.has(recipient.id)) {
            selectedRecipients.delete(recipient.id);
        } else {
            selectedRecipients.add(recipient.id);
        }
    });
    
    displayRecipients();
    toastr.info('Selección invertida');
}

function selectRandom(count) {
    // Deseleccionar todos primero
    selectedRecipients.clear();
    
    // Seleccionar aleatoriamente
    const shuffled = [...recipients].sort(() => 0.5 - Math.random());
    const selected = shuffled.slice(0, Math.min(count, recipients.length));
    
    selected.forEach(recipient => {
        selectedRecipients.add(recipient.id);
    });
    
    displayRecipients();
    toastr.success(`${selected.length} destinatarios seleccionados aleatoriamente`);
}

function removeSelected() {
    if (selectedRecipients.size === 0) {
        toastr.warning('No hay destinatarios seleccionados para eliminar');
        return;
    }
    
    Swal.fire({
        title: '¿Eliminar seleccionados?',
        text: `Se eliminarán ${selectedRecipients.size} destinatarios`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Sí, eliminar',
        cancelButtonText: 'Cancelar',
        width: 500
    }).then((result) => {
        if (result.isConfirmed) {
            recipients = recipients.filter(recipient => !selectedRecipients.has(recipient.id));
            selectedRecipients.clear();
            
            displayRecipients();
            updateSelectionSummary();
            updateReadyCount();
            
            toastr.success('Destinatarios eliminados');
        }
    });
}

function clearRecipients() {
    if (recipients.length === 0) return;
    
    Swal.fire({
        title: '¿Limpiar lista?',
        text: `Se eliminarán ${recipients.length} destinatarios`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Sí, limpiar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            recipients = [];
            selectedRecipients.clear();
            
            document.getElementById('recipients-body').innerHTML = '';
            document.getElementById('recipients-preview').classList.add('hidden');
            document.getElementById('selection-controls').classList.add('hidden');
            document.getElementById('selection-stats').classList.add('hidden');
            document.getElementById('search-container').classList.add('hidden');
            document.getElementById('excel-file').value = '';
            
            updateSelectionSummary();
            updateReadyCount();
            toastr.info('Lista limpiada');
        }
    });
}

function downloadTemplate() {
    const data = [
        ['Nombre', 'Correo Electrónico', 'Empresa', 'Teléfono'],
        ['Juan Pérez', 'juan.perez@ejemplo.com', 'TechCorp', '555-1234'],
        ['María García', 'maria.garcia@ejemplo.com', 'Innovatech', '555-5678'],
        ['Carlos López', 'carlos.lopez@ejemplo.com', 'Digital Solutions', '555-9012'],
        ['Ana Rodríguez', 'ana.rodriguez@ejemplo.com', 'WebMasters', '555-3456'],
        ['Pedro Sánchez', 'pedro.sanchez@ejemplo.com', 'NetSystems', '555-7890']
    ];
    
    const ws = XLSX.utils.aoa_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Destinatarios");
    
    XLSX.writeFile(wb, "plantilla_destinatarios.xlsx");
    toastr.success('Plantilla descargada');
}

// Funciones de navegación
function nextStep() {
    if (currentStep === 1) {
        if (recipients.length === 0) {
            toastr.error('Primero carga un archivo Excel con destinatarios');
            return;
        }
        
        if (selectedRecipients.size === 0) {
            toastr.error('Selecciona al menos un destinatario para enviar');
            return;
        }
        
        // Actualizar resumen de selección
        updateSelectionSummary();
    }
    
    if (currentStep === 2) {
        const senderEmail = document.getElementById('sender-email').value;
        const subject = document.getElementById('email-subject').value;
        const message = document.getElementById('email-message').value;
        
        if (!senderEmail || !isValidEmail(senderEmail)) {
            toastr.error('Ingresa un correo remitente válido');
            return;
        }
        
        if (!subject.trim()) {
            toastr.error('Ingresa un asunto para el correo');
            return;
        }
        
        if (!message.trim()) {
            toastr.error('Escribe un mensaje para el correo');
            return;
        }
        
        if (!emailJSInitialized) {
            Swal.fire({
                icon: 'warning',
                title: 'EmailJS no configurado',
                html: `
                    <div style="text-align: left;">
                        <p>Para enviar correos reales, debes configurar EmailJS primero.</p>
                        <br>
                        <p><strong>¿Deseas configurarlo ahora?</strong></p>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonColor: '#4361ee',
                cancelButtonColor: '#64748b',
                confirmButtonText: 'Sí, configurar',
                cancelButtonText: 'Continuar de todos modos'
            }).then((result) => {
                if (result.isConfirmed) {
                    return; // Permanece en el paso 2
                } else {
                    goToNextStep();
                }
            });
            return;
        }
    }
    
    goToNextStep();
}

function goToNextStep() {
    document.getElementById(`step-${currentStep}`).classList.add('hidden');
    
    const currentStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
    const currentStepLine = document.querySelector(`.step-line:nth-child(${currentStep * 2})`);
    
    currentStepEl.classList.remove('active');
    currentStepEl.classList.add('completed');
    
    if (currentStepLine) {
        currentStepLine.classList.remove('active');
    }
    
    currentStep++;
    
    document.getElementById(`step-${currentStep}`).classList.remove('hidden');
    
    const nextStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
    const prevStepLine = document.querySelector(`.step-line:nth-child(${(currentStep - 1) * 2})`);
    
    nextStepEl.classList.add('active');
    
    if (prevStepLine) {
        prevStepLine.classList.add('active');
    }
    
    if (currentStep === 3) {
        updateReadyCount();
        updateSelectionSummary();
    }
}

function prevStep() {
    if (currentStep === 1) return;
    
    document.getElementById(`step-${currentStep}`).classList.add('hidden');
    
    const currentStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
    const prevStepLine = document.querySelector(`.step-line:nth-child(${(currentStep - 1) * 2})`);
    
    currentStepEl.classList.remove('active');
    
    if (prevStepLine) {
        prevStepLine.classList.remove('active');
    }
    
    currentStep--;
    
    document.getElementById(`step-${currentStep}`).classList.remove('hidden');
    
    const prevStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
    prevStepEl.classList.add('active');
}

function goBackToSelection() {
    // Ir directamente al paso 1
    document.getElementById(`step-${currentStep}`).classList.add('hidden');
    
    const currentStepEl = document.querySelector(`.step[data-step="${currentStep}"]`);
    currentStepEl.classList.remove('active');
    
    currentStep = 1;
    
    document.getElementById(`step-1`).classList.remove('hidden');
    
    const step1El = document.querySelector(`.step[data-step="1"]`);
    step1El.classList.add('active');
    
    // Actualizar líneas de paso
    document.querySelectorAll('.step-line').forEach(line => {
        line.classList.remove('active');
    });
    
    document.querySelectorAll('.step').forEach(step => {
        if (parseInt(step.getAttribute('data-step')) < currentStep) {
            step.classList.add('completed');
        } else if (parseInt(step.getAttribute('data-step')) > currentStep) {
            step.classList.remove('completed');
        }
    });
}

// Funciones del editor de mensajes
function insertAtCursor(elementId, text) {
    const textarea = document.getElementById(elementId);
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const value = textarea.value;
    
    textarea.value = value.substring(0, start) + text + value.substring(end);
    textarea.selectionStart = textarea.selectionEnd = start + text.length;
    textarea.focus();
}

// Funciones de envío
function updateReadyCount() {
    const selectedCount = selectedRecipients.size;
    document.getElementById('ready-count').textContent = selectedCount;
}

function updateSelectionSummary() {
    const selectedCount = selectedRecipients.size;
    const totalCount = recipients.length;
    const unselectedCount = totalCount - selectedCount;
    const percentage = totalCount > 0 ? Math.round((selectedCount / totalCount) * 100) : 0;
    
    document.getElementById('summary-selected').textContent = selectedCount;
    document.getElementById('summary-unselected').textContent = unselectedCount;
    document.getElementById('summary-percentage').textContent = `${percentage}%`;
}

async function sendTestEmail() {
    if (!emailJSInitialized) {
        toastr.error('Primero configura EmailJS para enviar correos');
        return;
    }
    
    const testEmail = prompt('Ingresa un correo para enviar la prueba:', 'test@ejemplo.com');
    
    if (!testEmail || !isValidEmail(testEmail)) {
        toastr.error('Correo no válido');
        return;
    }
    
    const senderName = document.getElementById('sender-name').value;
    const senderEmail = document.getElementById('sender-email').value;
    const subject = document.getElementById('email-subject').value;
    let message = document.getElementById('email-message').value;
    
    // Personalizar mensaje
    message = message
        .replace(/{nombre}/g, 'Usuario de Prueba')
        .replace(/{email}/g, testEmail)
        .replace(/{fecha}/g, new Date().toLocaleDateString('es-ES'))
        .replace(/{numero}/g, '001')
        .replace(/{tu_nombre}/g, senderName)
        .replace(/{tu_empresa}/g, senderName);
    
    const serviceId = localStorage.getItem('mailmaster_emailjs_service_id');
    const templateId = localStorage.getItem('mailmaster_emailjs_template_id');
    
    const templateParams = {
        to_name: 'Usuario de Prueba',
        to_email: testEmail,
        from_name: senderName,
        from_email: senderEmail,
        subject: subject + ' [PRUEBA]',
        message: message,
        reply_to: senderEmail
    };
    
    try {
        showLoading('Enviando correo de prueba...');
        
        const response = await emailjs.send(serviceId, templateId, templateParams);
        
        hideLoading();
        Swal.fire({
            icon: 'success',
            title: '¡Prueba enviada!',
            html: `
                <div style="text-align: left;">
                    <p><strong>Correo de prueba enviado correctamente a:</strong></p>
                    <p style="color: #4361ee; font-weight: bold;">${testEmail}</p>
                    <br>
                    <p><strong>Detalles del envío:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li><strong>Estado:</strong> ${response.status}</li>
                        <li><strong>ID:</strong> ${response.messageId || 'N/A'}</li>
                        <li><strong>Hora:</strong> ${new Date().toLocaleTimeString()}</li>
                    </ul>
                </div>
            `,
            width: 500,
            confirmButtonColor: '#10b981'
        });
        
    } catch (error) {
        hideLoading();
        console.error('Error enviando prueba:', error);
        
        Swal.fire({
            icon: 'error',
            title: 'Error al enviar prueba',
            html: `
                <div style="text-align: left;">
                    <p><strong>Error:</strong> ${error.text || error.message || 'Error desconocido'}</p>
                    <br>
                    <p><strong>Posibles soluciones:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Verifica tu configuración de EmailJS</li>
                        <li>Asegúrate de que el correo remitente esté verificado en EmailJS</li>
                        <li>Revisa que la plantilla tenga los campos correctos</li>
                        <li>Verifica tu conexión a internet</li>
                    </ul>
                </div>
            `,
            width: 500
        });
    }
}

async function startSending() {
    const selectedCount = selectedRecipients.size;
    
    if (selectedCount === 0) {
        toastr.error('No hay destinatarios seleccionados para enviar');
        return;
    }
    
    if (isSending) {
        toastr.warning('Ya hay un envío en progreso');
        return;
    }
    
    if (!emailJSInitialized) {
        toastr.error('Primero configura EmailJS para enviar correos');
        return;
    }
    
    // Confirmación final
    Swal.fire({
        title: '¿Iniciar envío masivo REAL?',
        html: `
            <div style="text-align: left;">
                <p><strong>Destinatarios seleccionados:</strong> ${selectedCount}</p>
                <p><strong>Remitente:</strong> ${document.getElementById('sender-email').value}</p>
                <p><strong>Asunto:</strong> ${document.getElementById('email-subject').value}</p>
                <br>
                <p style="color: #ef4444; font-size: 0.9rem;">
                    <i class="fas fa-exclamation-triangle"></i> 
                    <strong>ADVERTENCIA:</strong> Esto enviará correos REALES solo a los destinatarios seleccionados. No cierres esta pestaña durante el envío.
                </p>
                <p style="color: #10b981; font-size: 0.9rem;">
                    <i class="fas fa-info-circle"></i> 
                    Tiempo estimado: ${Math.ceil(selectedCount * parseInt(document.getElementById('send-speed').value) / 1000 / 60)} minutos
                </p>
            </div>
        `,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#10b981',
        cancelButtonColor: '#ef4444',
        confirmButtonText: 'Sí, iniciar envío REAL',
        cancelButtonText: 'Cancelar',
        width: 500
    }).then((result) => {
        if (result.isConfirmed) {
            prepareSending();
        }
    });
}

function prepareSending() {
    isSending = true;
    currentIndex = 0;
    sentCount = 0;
    failedCount = 0;
    
    // Solo enviar a los seleccionados
    const recipientsToSend = recipients.filter(recipient => selectedRecipients.has(recipient.id));
    
    document.getElementById('send-ready').classList.add('hidden');
    document.getElementById('progress-container').classList.remove('hidden');
    
    updateProgress(recipientsToSend.length);
    
    const speed = parseInt(document.getElementById('send-speed').value);
    
    // Guardar tiempo de inicio
    window.sendStartTime = Date.now();
    
    sendInterval = setInterval(() => {
        sendNextEmail(recipientsToSend);
    }, speed);
}

async function sendNextEmail(recipientsToSend) {
    if (currentIndex >= recipientsToSend.length) {
        finishSending(recipientsToSend.length);
        return;
    }
    
    const recipient = recipientsToSend[currentIndex];
    const senderName = document.getElementById('sender-name').value;
    const senderEmail = document.getElementById('sender-email').value;
    const subject = document.getElementById('email-subject').value;
    let message = document.getElementById('email-message').value;
    
    message = message
        .replace(/{nombre}/g, recipient.nombre)
        .replace(/{email}/g, recipient.email)
        .replace(/{fecha}/g, new Date().toLocaleDateString('es-ES'))
        .replace(/{numero}/g, (currentIndex + 1).toString().padStart(3, '0'))
        .replace(/{tu_nombre}/g, senderName)
        .replace(/{tu_empresa}/g, senderName);
    
    const serviceId = localStorage.getItem('mailmaster_emailjs_service_id');
    const templateId = localStorage.getItem('mailmaster_emailjs_template_id');
    
    const templateParams = {
        to_name: recipient.nombre,
        to_email: recipient.email,
        from_name: senderName,
        from_email: senderEmail,
        subject: subject,
        message: message,
        reply_to: senderEmail
    };
    
    try {
        const response = await emailjs.send(serviceId, templateId, templateParams);
        
        sentCount++;
        updateRecipientStatus(recipient.id, 'success');
        
        // Mostrar progreso en consola
        console.log(`✅ Correo ${currentIndex + 1}/${recipientsToSend.length} enviado a: ${recipient.email}`);
        
    } catch (error) {
        failedCount++;
        updateRecipientStatus(recipient.id, 'error');
        
        console.error(`❌ Error enviando a ${recipient.email}:`, error);
        
        // Guardar error en log
        saveErrorLog(recipient.email, error);
    }
    
    currentIndex++;
    updateProgress(recipientsToSend.length);
}

function saveErrorLog(email, error) {
    const logs = JSON.parse(localStorage.getItem('mailmaster_error_logs') || '[]');
    logs.push({
        email: email,
        error: error.text || error.message || 'Error desconocido',
        timestamp: new Date().toISOString()
    });
    localStorage.setItem('mailmaster_error_logs', JSON.stringify(logs));
}

function updateProgress(total) {
    const progress = (currentIndex / total) * 100;
    const pending = total - currentIndex;
    
    document.getElementById('progress-fill').style.width = `${progress}%`;
    document.getElementById('progress-percent').textContent = `${Math.round(progress)}%`;
    
    document.getElementById('sent-count').textContent = sentCount;
    document.getElementById('failed-count').textContent = failedCount;
    document.getElementById('pending-count').textContent = pending;
}

function finishSending(total) {
    clearInterval(sendInterval);
    isSending = false;
    
    const successRate = total > 0 ? Math.round((sentCount / total) * 100) : 0;
    
    // Mostrar log de errores si hay
    let errorLogHtml = '';
    const errorLogs = JSON.parse(localStorage.getItem('mailmaster_error_logs') || '[]');
    
    if (errorLogs.length > 0 && failedCount > 0) {
        errorLogHtml = `
            <div style="margin-top: 20px; text-align: left;">
                <p><strong>Errores encontrados (${failedCount}):</strong></p>
                <div style="max-height: 200px; overflow-y: auto; background: #f8fafc; padding: 10px; border-radius: 8px; margin-top: 10px;">
                    ${errorLogs.slice(-failedCount).map(log => `
                        <div style="padding: 5px 0; border-bottom: 1px solid #e2e8f0;">
                            <strong>${log.email}</strong>: ${log.error}
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    
    Swal.fire({
        title: '¡Envío REAL completado!',
        html: `
            <div style="text-align: center;">
                <div style="font-size: 60px; color: #10b981; margin-bottom: 20px;">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin: 20px 0;">
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #10b981;">${sentCount}</div>
                        <div style="color: #64748b;">Enviados</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #ef4444;">${failedCount}</div>
                        <div style="color: #64748b;">Fallados</div>
                    </div>
                    <div>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">${successRate}%</div>
                        <div style="color: #64748b;">Tasa de éxito</div>
                    </div>
                </div>
                ${errorLogHtml}
                <div style="margin-top: 20px; font-size: 0.9rem; color: #64748b;">
                    <i class="fas fa-clock"></i> Tiempo total: ${Math.round((Date.now() - window.sendStartTime) / 1000 / 60)} minutos
                </div>
            </div>
        `,
        confirmButtonColor: '#667eea',
        confirmButtonText: 'Aceptar',
        width: 500
    });
    
    // Limpiar logs antiguos
    localStorage.removeItem('mailmaster_error_logs');
    
    document.getElementById('send-ready').classList.remove('hidden');
    document.getElementById('progress-container').classList.add('hidden');
}

function cancelSending() {
    if (!isSending) return;
    
    Swal.fire({
        title: '¿Cancelar envío?',
        text: `Se han enviado ${sentCount} de ${selectedRecipients.size} correos`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Sí, cancelar',
        cancelButtonText: 'Continuar'
    }).then((result) => {
        if (result.isConfirmed) {
            clearInterval(sendInterval);
            isSending = false;
            
            document.getElementById('send-ready').classList.remove('hidden');
            document.getElementById('progress-container').classList.add('hidden');
            
            toastr.info(`Envío cancelado. Se enviaron ${sentCount} correos REALES.`);
        }
    });
}

// Función para actualizar estado del destinatario
function updateRecipientStatus(id, status) {
    const rows = document.querySelectorAll('#recipients-body tr');
    
    for (let row of rows) {
        const checkbox = row.querySelector('input[type="checkbox"]');
        if (checkbox && checkbox.getAttribute('data-id') === id) {
            const statusCell = row.querySelector('.status');
            if (statusCell) {
                if (status === 'success') {
                    statusCell.textContent = 'Enviado';
                    statusCell.className = 'status success';
                } else {
                    statusCell.textContent = 'Falló';
                    statusCell.className = 'status error';
                }
            }
            break;
        }
    }
}

// Funciones de utilidad
function isValidEmail(email) {
    const re = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    return re.test(email);
}

function showLoading(text) {
    Swal.fire({
        title: text,
        allowOutsideClick: false,
        showConfirmButton: false,
        willOpen: () => {
            Swal.showLoading();
        }
    });
}

function hideLoading() {
    Swal.close();
}

function loadSavedData() {
    const savedSenderEmail = localStorage.getItem('mailmaster_sender_email');
    const savedSenderName = localStorage.getItem('mailmaster_sender_name');
    const savedSubject = localStorage.getItem('mailmaster_subject');
    const savedMessage = localStorage.getItem('mailmaster_message');
    
    if (savedSenderEmail) document.getElementById('sender-email').value = savedSenderEmail;
    if (savedSenderName) document.getElementById('sender-name').value = savedSenderName;
    if (savedSubject) document.getElementById('email-subject').value = savedSubject;
    if (savedMessage) document.getElementById('email-message').value = savedMessage;
}

// Guardar datos automáticamente
document.getElementById('sender-email').addEventListener('input', function() {
    localStorage.setItem('mailmaster_sender_email', this.value);
});

document.getElementById('sender-name').addEventListener('input', function() {
    localStorage.setItem('mailmaster_sender_name', this.value);
});

document.getElementById('email-subject').addEventListener('input', function() {
    localStorage.setItem('mailmaster_subject', this.value);
});

document.getElementById('email-message').addEventListener('input', function() {
    localStorage.setItem('mailmaster_message', this.value);
});

// Instrucciones iniciales
window.addEventListener('load', function() {
    if (!localStorage.getItem('mailmaster_welcome_shown')) {
        setTimeout(() => {
            Swal.fire({
                title: '¡Bienvenido a MailMaster PRO!',
                html: `
                    <div style="text-align: left; line-height: 1.6;">
                        <p><strong>Sistema de envío REAL de correos:</strong></p>
                        <ol style="margin-left: 20px; margin-top: 10px;">
                            <li><strong>Selección individual:</strong> Elige exactamente a quiénes enviar correos</li>
                            <li><strong>Envío real:</strong> Usa EmailJS para enviar correos reales</li>
                            <li><strong>Configuración simple:</strong> Solo necesitas una cuenta gratuita de EmailJS</li>
                            <li><strong>Personalización completa:</strong> Usa etiquetas para personalizar cada correo</li>
                            <li><strong>Control total:</strong> Selecciona, filtra y organiza tus destinatarios</li>
                            <li><strong>Seguro:</strong> Sin almacenar datos en servidores externos</li>
                        </ol>
                        <br>
                        <p style="color: #667eea;">
                            <i class="fas fa-lightbulb"></i> 
                            <strong>PRIMEROS PASOS:</strong> 
                            <ol style="margin-left: 20px;">
                                <li>Carga tu archivo Excel con correos</li>
                                <li>Selecciona individualmente a quiénes enviar (usa los checkboxes)</li>
                                <li>Configura EmailJS en el Paso 2</li>
                            </ol>
                        </p>
                    </div>
                `,
                icon: 'success',
                confirmButtonColor: '#667eea',
                confirmButtonText: 'Comenzar',
                width: 600
            });
            
            localStorage.setItem('mailmaster_welcome_shown', 'true');
        }, 1000);
    }
});
    </script>
</body>
</html>
